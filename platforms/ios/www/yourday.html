<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, user-scalable=no
		initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Rock This Way</title>

    <link href="ui/css/style.css" rel="stylesheet">

    <script src="cordova.js"></script>
    <script src="js/app.js"></script>
    <script src="bundle.js"></script>
    
    <script>
        //script for testing Modals
        function triggerModal() {
            //$("#myModal").modal()
        }
        
        $(function(){
            $('body').hide().fadeIn('slow');
            displayPlan();
        });

    </script>


    <script>
        //This Entire Script is for the iBeacons
        var app = (function () {
            // Application object.
            var app = {};

            // History of enter/exit events.
            var mRegionEvents = [];

            // Nearest ranged beacon.
            var mNearestBeacon = null;

            // Timer that displays nearby beacons.
            var mNearestBeaconDisplayTimer = null;

            // Background flag.
            var mAppInBackground = false;

            // Background notification id counter.
            var mNotificationId = 0;

            var previousBeacon;

            // Mapping of region event state names.
            // These are used in the event display string.
            var mRegionStateNames = {
                'CLRegionStateInside': 'Enter',
                'CLRegionStateOutside': 'Exit'
            };

            //Looks for beacons that have the following properties.
            //In order for a beacon to be detected, it has to be put into the following list
            var mRegions = [
                {
                    id: 'region1',
                    uuid: '7b44b47b-52a1-5381-90c2-f09b6838c5d4',
                    major: 112,
                    minor: 154
		},
                {
                    id: 'region2',
                    uuid: '7b44b47b-52a1-5381-90c2-f09b6838c5d4',
                    major: 152,
                    minor: 114
		},
                {
                    id: 'region3',
                    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D',
                    major: 19175,
                    minor: 17780
		},
                {
                    id: 'region4',
                    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D',
                    major: 18015,
                    minor: 60062
		},
                {
                    id: 'region5',
                    uuid: 'B9407F30-F5F8-466E-AFF9-25556B57FE6D',
                    major: 50017,
                    minor: 64202
		}

	];

            //Name of the beacons in range.
            var mRegionData = {
                'region1': 'iPhone iBeacon',
                'region2': 'iPhone iBeacon',
                'region3': 'Green Estimote Beacon',
                'region4': 'Ice Estimote Beacon',
                'region5': 'Indigo Estimote Beacon'
            };

            app.initialize = function () {
                document.addEventListener('deviceready', onDeviceReady, false);
                document.addEventListener('pause', onAppToBackground, false);
                document.addEventListener('resume', onAppToForeground, false);
            };

            function onDeviceReady() {
                startMonitoringAndRanging();
                startNearestBeaconDisplayTimer();
                displayRegionEvents();
            }

            function onAppToBackground() {
                mAppInBackground = true;
                stopNearestBeaconDisplayTimer();
            }

            function onAppToForeground() {
                mAppInBackground = false;
                startNearestBeaconDisplayTimer();
                displayRegionEvents();
            }

            function startNearestBeaconDisplayTimer() {
                mNearestBeaconDisplayTimer = setInterval(displayNearestBeacon, 1000);
            }

            function stopNearestBeaconDisplayTimer() {
                clearInterval(mNearestBeaconDisplayTimer);
                mNearestBeaconDisplayTimer = null;
            }

            function startMonitoringAndRanging() {
                function onDidDetermineStateForRegion(result) {
                    saveRegionEvent(result.state, result.region.identifier);
                    displayRecentRegionEvent();
                }

                function onDidRangeBeaconsInRegion(result) {
                    updateNearestBeacon(result.beacons);
                }

                function onError(errorMessage) {
                    console.log('Monitoring beacons did fail: ' + errorMessage);
                }

                // Request permission from user to access location info.
                cordova.plugins.locationManager.requestAlwaysAuthorization();

                // Create delegate object that holds beacon callback functions.
                var delegate = new cordova.plugins.locationManager.Delegate();
                cordova.plugins.locationManager.setDelegate(delegate);

                // Set delegate functions.
                delegate.didDetermineStateForRegion = onDidDetermineStateForRegion;
                delegate.didRangeBeaconsInRegion = onDidRangeBeaconsInRegion;

                // Start monitoring and ranging beacons.
                startMonitoringAndRangingRegions(mRegions, onError);
            }

            function startMonitoringAndRangingRegions(regions, errorCallback) {
                // Start monitoring and ranging regions.
                for (var i in regions) {
                    startMonitoringAndRangingRegion(regions[i], errorCallback);
                }
            }

            function startMonitoringAndRangingRegion(region, errorCallback) {
                // Create a region object.
                var beaconRegion = new cordova.plugins.locationManager.BeaconRegion(
                    region.id,
                    region.uuid,
                    region.major,
                    region.minor);

                // Start ranging.
                cordova.plugins.locationManager.startRangingBeaconsInRegion(beaconRegion)
                    .fail(errorCallback)
                    .done();

                // Start monitoring.
                cordova.plugins.locationManager.startMonitoringForRegion(beaconRegion)
                    .fail(errorCallback)
                    .done();
            }

            function saveRegionEvent(eventType, regionId) {
                // Save event.
                mRegionEvents.push({
                    type: eventType,
                    time: getTimeNow(),
                    regionId: regionId
                });

                // Truncate if more than ten entries.
                if (mRegionEvents.length > 10) {
                    mRegionEvents.shift();
                }
            }

            function getBeaconId(beacon) {
                return beacon.uuid + ':' + beacon.major + ':' + beacon.minor;
            }

            function isSameBeacon(beacon1, beacon2) {
                return getBeaconId(beacon1) == getBeaconId(beacon2);
            }

            function isNearerThan(beacon1, beacon2) {
                return beacon1.accuracy > 0 && beacon2.accuracy > 0 && beacon1.accuracy < beacon2.accuracy;
            }

            function updateNearestBeacon(beacons) {
                for (var i = 0; i < beacons.length; ++i) {
                    var beacon = beacons[i];
                    if (!mNearestBeacon) {
                        mNearestBeacon = beacon;
                    } else {
                        if (isSameBeacon(beacon, mNearestBeacon) ||
                            isNearerThan(beacon, mNearestBeacon)) {
                            mNearestBeacon = beacon;
                        }
                    }
                }
            }

            function displayNearestBeacon() {
                if (!mNearestBeacon) {
                    return;
                }
                // If the nearest beacon changes, the code on beacons.html will change to the following based on beacon.major
                if (mNearestBeacon.major != previousBeacon) {
                    if (mNearestBeacon.major == 19175) {
                        $('#modalTitle').text("Play Who Wants to be a Rockstar?");
                        $("#modalPlay").attr("onclick", "playGame(2)");
                        $("#modalDescription").text("Play a fast paced True or False Trivia game! See how many answers you can get right before time runs out.");
                    } else if (mNearestBeacon.major == 18015) {
                        $('#modalTitle').text("Play Against the Crowd");
                        $("#modalPlay").attr("onclick", "playGame(3)");
                        $("#modalDescription").text("Put your guesses up against others at the Rock Hall! We'll as you a question and you say what you think the answer should be. The more popular your answer is, the more points you get.");
                    } else if (mNearestBeacon.major == 50017) {
                        $("#modalPlay").attr("onclick", "playGame(1)");
                        $('#modalTitle').text("Play Lyracle");
                        $("#modalDescription").text("A Lyric game where we give you part of a song, and you must put the lyrics that follow in order!");
                    } 
                    else if (mNearestBeacon.major == 112) {
                        $("#modalPlay").hide();
                        $("#modalExhibit").attr("onclick", "leaveExhibits()");
                        $("#modalExhibit").text("Leave");
                        $('#modalTitle').text("Leave Exhibit?");
                        $("#modalDescription").text("If you are leaving the exhibit please press the following button and give this phone to an exhibitor.");
                    }else {
                    }
                    $("#myModal").modal();
                }

                previousBeacon = mNearestBeacon.major;


            }

            function displayRecentRegionEvent() {
                if (mAppInBackground) {
                    // Set notification title.
                    var event = mRegionEvents[mRegionEvents.length - 1];
                    if (!event) {
                        return;
                    }
                    var title = getEventDisplayString(event);

                    // Create notification.
                    cordova.plugins.notification.local.schedule({
                        id: ++mNotificationId,
                        title: title
                    });
                } else {
                    displayRegionEvents();
                }
            }

            function displayRegionEvents() {
                // Displayed before it connects to beacons or while there is no beacon in range.
                //uncomment bottom line if we need to change the home screen.

            }

            function getEventDisplayString(event) {
                return event.time + ': ' + mRegionStateNames[event.type] + ' ' + mRegionData[event.regionId];
            }

            function getTimeNow() {
                function pad(n) {
                    return (n < 10) ? '0' + n : n;
                }

                function format(h, m, s) {
                    return pad(h) + ':' + pad(m) + ':' + pad(s);
                }

                var d = new Date();
                return format(d.getHours(), d.getMinutes(), d.getSeconds());
            }
            
            return app;

        })();
        
        function leaveExhibits(){
            window.location.href = "submitscore.html";
        }
        
        function goToExhibit(exhibit){
            var link = "exhibit.html?exhibit="+exhibit;
            window.location.href = link;
            
        }

        function goToUser(){
            window.location.href = "user.html";
        }
        
        function playGame(game) {
            if (game == 1) {
                window.location.href = "rules.html?game=1";
            }
            if (game == 2) {
                window.location.href = "rules.html?game=2";
            }
            if (game == 3) {
                window.location.href = "rules.html?game=3";
            }
        }

        //adds the CSS to display exhibit cards
        function displayPlan(){
            $('body').css("overflow", "visible");
            var element = document.getElementById("homeScreen");
            
            var heading = document.createElement("h1");
            var headingText = document.createTextNode("Today's Plan");
            heading.appendChild(headingText);
            element.appendChild(heading);
            
            for(var i=0; i < 3; i++){
                var container = document.createElement("div");
                $(container).addClass("card card-3 exhibit");
                $(container).css("margin-top", "5%");
                element.appendChild(container);
                
                var container2 = document.createElement("div");
                $(container2).addClass("half-card");
                $(container2).css("margin-top", "5%");
                container.appendChild(container2);
                                
                var para3 = document.createElement("p");
                $(para3).css("text-align", "left");
                container2.appendChild(para3);
               
                var image = $('<img src="images/welcome.png">');
                image.addClass("exhibitImage");
                image.appendTo(container);
                
                var exhibitTitle2 = document.createTextNode("Exhibit Title");
                para3.appendChild(exhibitTitle2);
                                
                var para = document.createElement("p");
                $(para).addClass("exhibit");
                $(para).css("text-align", "left");
                container.appendChild(para);
                
                var exhibitTitle = document.createTextNode("Exhibit Title");
                para.appendChild(exhibitTitle);
                
                var para2 = document.createElement("p");
                $(para2).addClass("exhbit title");
                $(para2).css("font-style", "normal");
                $(para2).css("text-align", "left");
                container.appendChild(para2);
                
                var exhibitText = document.createTextNode("Exhibit Info");
                para2.appendChild(exhibitText);
                
                container.style.clear = "left";
            }
        }
        
        var flipped = false;
        //toggles between the plan screen and map screen
        function flipPage() {
            //creating location markers and putting them in their own divs
            var markers = document.getElementById("markers");
            for(var i=0; i<3; i++) {
                var image = $('<img src="ui/images/pick-location-marker.png">');
                var marker = document.createElement("div");
                
                $(marker).addClass("marker" + (i+1));
                markers.appendChild(marker);
                image.appendTo(marker);
                
                marker.addEventListener("click", function(){console.log("hi")});
            }
            document.querySelector("#flip-toggle").classList.toggle("flip");
            
            if(!flipped) {
                flipped = true;
            } else {
                flipped = false;
            }
            if(!flipped) {
                $(markers).empty();
                $(map).css("overflow", "hidden");
            } else {
                $(map).css("overflow", "visible");
            }
        }
        
        app.initialize();
    </script>

</head>

<body>

    <header>

        <button class="back" onclick="goToUser()">
            <img src="images/user.png" />
        </button>

        <button class="swap" onclick="flipPage()">
            <img src="ui/images/BaseMap.png" />
        </button>

        <img src="images/logo2.png" height="50px" />
    
    </header>
    
    <div class="flip-container" id="flip-toggle">
        <div class="flipper">
            <div class="frontPage">
                <ul id="homeScreen" class="dynamic">
                </ul>
            </div>
            <div class="backPage">
                <div id="map">
                    <img src="images/rock-hall-map.png" width="351%"/>
                    <div id="markers"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="myModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title" id="modalTitle">Play Lyracle</h4>
                </div>
                <div class="modal-body">
                    <p id="modalDescription">Play a game where you get a clip of a song, then you have to put the rest of the lyrics in order!</p>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-default" data-dismiss="modal" id="modalPlay" onclick="playGame(1)">Game</button>
                </div>
            </div>

        </div>
    </div>


</body>

</html>